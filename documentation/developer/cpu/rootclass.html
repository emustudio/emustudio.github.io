<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Plugin Root - Developer documentation for emuStudio</title> <link rel="shortcut icon" href="/documentation/developer/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/documentation/developer/assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3492956-5"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-3492956-5', { 'anonymize_ip': true }); </script> <script src="/documentation/developer/assets/js/vendor/lunr.min.js"></script> <script src="/documentation/developer/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Plugin Root | Developer documentation for emuStudio</title> <meta name="generator" content="Jekyll v4.3.1" /> <meta property="og:title" content="Plugin Root" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Developer documentation for emuStudio. emuStudio is universal emulation platform and framework targeting mainly academic sphere." /> <meta property="og:description" content="Developer documentation for emuStudio. emuStudio is universal emulation platform and framework targeting mainly academic sphere." /> <link rel="canonical" href="/documentation/developer/cpu/rootclass" /> <meta property="og:url" content="/documentation/developer/cpu/rootclass" /> <meta property="og:site_name" content="Developer documentation for emuStudio" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Plugin Root" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Developer documentation for emuStudio. emuStudio is universal emulation platform and framework targeting mainly academic sphere.","headline":"Plugin Root","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/documentation/developer/assets/logo-1.svg"}},"url":"/documentation/developer/cpu/rootclass"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/documentation/developer/" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Introduction category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/documentation/developer/introduction/" class="nav-list-link">Introduction</a><ul class="nav-list "></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Getting started category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/documentation/developer/getting_started/" class="nav-list-link">Getting started</a><ul class="nav-list "><li class="nav-list-item "><a href="/documentation/developer/getting_started/contributing" class="nav-list-link">How to contribute</a></li><li class="nav-list-item "><a href="/documentation/developer/getting_started/gitflow" class="nav-list-link">Git workflow</a></li><li class="nav-list-item "><a href="/documentation/developer/getting_started/documenting" class="nav-list-link">Documenting</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Plugin basics category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/documentation/developer/plugin_basics/" class="nav-list-link">Plugin basics</a><ul class="nav-list "><li class="nav-list-item "><a href="/documentation/developer/plugin_basics/loading" class="nav-list-link">Loading and initialization</a></li><li class="nav-list-item "><a href="/documentation/developer/plugin_basics/context" class="nav-list-link">Plugin contexts</a></li><li class="nav-list-item "><a href="/documentation/developer/plugin_basics/utility_classes" class="nav-list-link">Utility classes</a></li></ul></li><li class="nav-list-item"><a href="/documentation/developer/compiler/" class="nav-list-link">Writing a compiler</a></li><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in Writing a CPU category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/documentation/developer/cpu/" class="nav-list-link">Writing a CPU</a><ul class="nav-list "><li class="nav-list-item active"><a href="/documentation/developer/cpu/rootclass" class="nav-list-link active">Plugin Root</a></li><li class="nav-list-item "><a href="/documentation/developer/cpu/runstate" class="nav-list-link">Run states</a></li><li class="nav-list-item "><a href="/documentation/developer/cpu/engine" class="nav-list-link">Emulator engine</a></li><li class="nav-list-item "><a href="/documentation/developer/cpu/disassembler" class="nav-list-link">Disassembler</a></li></ul></li><li class="nav-list-item"><a href="/documentation/developer/memory/" class="nav-list-link">Writing a memory</a></li><li class="nav-list-item"><a href="/documentation/developer/device/" class="nav-list-link">Writing a device</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Developer documentation for emuStudio" aria-label="Search Developer documentation for emuStudio" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="/" class="site-button" > Back to website </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/documentation/developer/cpu/">Writing a CPU</a></li> <li class="breadcrumb-nav-list-item"><span>Plugin Root</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <script type="text/javascript"> gtag('event', 'developerdoc', { 'event_category': 'developer', 'event_label': 'Plugin Root' }); </script> <h1 id="plugin-root-class"> <a href="#plugin-root-class" class="anchor-heading" aria-labelledby="plugin-root-class"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Plugin root class </h1> <p>A CPU plugin root class must implement either a <a href="/documentation/developer/emulib_javadoc/net/emustudio/emulib/plugins/cpu/CPU.html" target="_blank">CPU</a> interface, or extend <a href="/documentation/developer/emulib_javadoc/net/emustudio/emulib/plugins/cpu/AbstractCPU.html" target="_blank">AbstractCPU</a> class.</p> <p><a href="/documentation/developer/emulib_javadoc/net/emustudio/emulib/plugins/cpu/AbstractCPU.html" target="_blank">AbstractCPU</a> implements several mechanisms which save developer time, like:</p> <ul> <li>emulation control methods (run, step, stop, pause, reset) are queued for execution in the same thread, and implements run state notification. It means that it is possible to call them from any other thread (e.g. also from Swing <a href="https://docs.oracle.com/javase/tutorial/uiswing/concurrency/dispatch.html" target="_blank">Event dispatch thread</a>)</li> <li>implements notification of run states (see next chapter)</li> <li>implements breakpoints management</li> </ul> <p>Sample implementation follows (only core methods are implemented):</p> <div class="language-java code-example highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@PluginRoot</span><span class="o">(</span>
        <span class="n">type</span> <span class="o">=</span> <span class="no">PLUGIN_TYPE</span><span class="o">.</span><span class="na">CPU</span><span class="o">,</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">"Sample CPU emulator"</span>
<span class="o">)</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unused"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CpuImpl</span> <span class="kd">extends</span> <span class="nc">AbstractCPU</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ContextImpl</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ContextImpl</span><span class="o">();</span>

    <span class="kd">private</span> <span class="nc">EmulatorEngine</span> <span class="n">engine</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Disassembler</span> <span class="n">disassembler</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">StatusPanel</span> <span class="n">statusPanel</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">CpuImpl</span><span class="o">(</span><span class="kt">long</span> <span class="n">pluginID</span><span class="o">,</span> <span class="nc">ApplicationApi</span> <span class="n">applicationApi</span><span class="o">,</span> <span class="nc">PluginSettings</span> <span class="n">settings</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">pluginID</span><span class="o">,</span> <span class="n">applicationApi</span><span class="o">,</span> <span class="n">settings</span><span class="o">);</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">applicationApi</span><span class="o">.</span><span class="na">getContextPool</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="n">pluginID</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="nc">ExtendedContext</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InvalidContextException</span> <span class="o">|</span> <span class="nc">ContextAlreadyRegisteredException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="no">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Could not register CPU context"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="n">applicationApi</span><span class="o">.</span><span class="na">getDialogs</span><span class="o">().</span><span class="na">showError</span><span class="o">(</span>
                    <span class="s">"Could not register CPU Context. Please see log file for details."</span><span class="o">,</span> <span class="kd">super</span><span class="o">.</span><span class="na">getTitle</span><span class="o">()</span>
            <span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">PluginInitializationException</span> <span class="o">{</span>
        <span class="nc">MemoryContext</span><span class="o">&lt;</span><span class="nc">Short</span><span class="o">&gt;</span> <span class="n">memory</span> <span class="o">=</span> <span class="n">contextPool</span><span class="o">.</span><span class="na">getMemoryContext</span><span class="o">(</span><span class="n">pluginId</span><span class="o">,</span> <span class="nc">MemoryContext</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">memory</span><span class="o">.</span><span class="na">getDataType</span><span class="o">()</span> <span class="o">!=</span> <span class="nc">Short</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidContextException</span><span class="o">(</span>
                    <span class="s">"Unexpected memory cell type. Expected Short but was: "</span> <span class="o">+</span> <span class="n">memory</span><span class="o">.</span><span class="na">getDataType</span><span class="o">()</span>
            <span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// create disassembler and debug columns</span>
        <span class="k">this</span><span class="o">.</span><span class="na">disassembler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DisassemblerImpl</span><span class="o">(</span><span class="n">memory</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DecoderImpl</span><span class="o">(</span><span class="n">memory</span><span class="o">));</span>
        <span class="k">this</span><span class="o">.</span><span class="na">engine</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EmulatorEngine</span><span class="o">(</span><span class="n">memory</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">destroyInternal</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">context</span><span class="o">.</span><span class="na">clearDevices</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">resetInternal</span><span class="o">(</span><span class="kt">int</span> <span class="n">location</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">engine</span><span class="o">.</span><span class="na">reset</span><span class="o">(</span><span class="n">location</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">RunState</span> <span class="nf">stepInternal</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">engine</span><span class="o">.</span><span class="na">step</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">JPanel</span> <span class="nf">getStatusPanel</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">statusPanel</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">statusPanel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StatusPanel</span><span class="o">(</span><span class="n">engine</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">statusPanel</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">RunState</span> <span class="nf">call</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">engine</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Disassembler</span> <span class="nf">getDisassembler</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">disassembler</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getInstructionLocation</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">engine</span><span class="o">.</span><span class="na">PC</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">setInstructionLocation</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">position</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">engine</span><span class="o">.</span><span class="na">PC</span> <span class="o">=</span> <span class="n">position</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="o">;</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>What can be noticed here is:</p> <ul> <li>this CPU register custom context in constructor. The context is custom, because it will allow attaching devices to specific CPU “ports”.</li> <li>obtaining <a href="/documentation/developer/emulib_javadoc/net/emustudio/emulib/plugins/memory/MemoryContext.html" target="_blank">MemoryContext</a> is vital. If it is not successful, the <a href="/documentation/developer/emulib_javadoc/net/emustudio/emulib/plugins/PluginInitializationException.html" target="_blank">PluginInitializationException</a> will be propagated to the caller.</li> <li>actual CPU emulation is implemented in <code class="language-plaintext highlighter-rouge">EmulatorEngine</code> class, which requires a memory and CPU context.</li> <li>classes <code class="language-plaintext highlighter-rouge">DisassemblerImpl</code> and <code class="language-plaintext highlighter-rouge">DecoderImpl</code> are generated by <a href="https://github.com/emustudio/edigen" target="_blank">Edigen</a></li> </ul> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
