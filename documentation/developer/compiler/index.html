<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Writing a compiler - Developer documentation for emuStudio</title> <link rel="shortcut icon" href="/documentation/developer/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/documentation/developer/assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-3492956-5"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-3492956-5', { 'anonymize_ip': true }); </script> <script src="/documentation/developer/assets/js/vendor/lunr.min.js"></script> <script src="/documentation/developer/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Writing a compiler | Developer documentation for emuStudio</title> <meta name="generator" content="Jekyll v4.3.1" /> <meta property="og:title" content="Writing a compiler" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Developer documentation for emuStudio. emuStudio is universal emulation platform and framework targeting mainly academic sphere." /> <meta property="og:description" content="Developer documentation for emuStudio. emuStudio is universal emulation platform and framework targeting mainly academic sphere." /> <link rel="canonical" href="/documentation/developer/compiler/" /> <meta property="og:url" content="/documentation/developer/compiler/" /> <meta property="og:site_name" content="Developer documentation for emuStudio" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Writing a compiler" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Developer documentation for emuStudio. emuStudio is universal emulation platform and framework targeting mainly academic sphere.","headline":"Writing a compiler","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/documentation/developer/assets/logo-1.svg"}},"url":"/documentation/developer/compiler/"}</script> <!-- End Jekyll SEO tag --> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/documentation/developer/" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/documentation/developer/introduction/" class="nav-list-link">Introduction</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Getting started category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/documentation/developer/getting_started/" class="nav-list-link">Getting started</a><ul class="nav-list "><li class="nav-list-item "><a href="/documentation/developer/getting_started/contributing" class="nav-list-link">How to contribute</a></li><li class="nav-list-item "><a href="/documentation/developer/getting_started/gitflow" class="nav-list-link">Git workflow</a></li><li class="nav-list-item "><a href="/documentation/developer/getting_started/documenting" class="nav-list-link">Documenting</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Plugin basics category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/documentation/developer/plugin_basics/" class="nav-list-link">Plugin basics</a><ul class="nav-list "><li class="nav-list-item "><a href="/documentation/developer/plugin_basics/loading" class="nav-list-link">Loading and initialization</a></li><li class="nav-list-item "><a href="/documentation/developer/plugin_basics/context" class="nav-list-link">Plugin contexts</a></li><li class="nav-list-item "><a href="/documentation/developer/plugin_basics/utility_classes" class="nav-list-link">Utility classes</a></li></ul></li><li class="nav-list-item active"><a href="/documentation/developer/compiler/" class="nav-list-link active">Writing a compiler</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Writing a CPU category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/documentation/developer/cpu/" class="nav-list-link">Writing a CPU</a><ul class="nav-list "><li class="nav-list-item "><a href="/documentation/developer/cpu/rootclass" class="nav-list-link">Plugin Root</a></li><li class="nav-list-item "><a href="/documentation/developer/cpu/runstate" class="nav-list-link">Run states</a></li><li class="nav-list-item "><a href="/documentation/developer/cpu/engine" class="nav-list-link">Emulator engine</a></li><li class="nav-list-item "><a href="/documentation/developer/cpu/disassembler" class="nav-list-link">Disassembler</a></li></ul></li><li class="nav-list-item"><a href="/documentation/developer/memory/" class="nav-list-link">Writing a memory</a></li><li class="nav-list-item"><a href="/documentation/developer/device/" class="nav-list-link">Writing a device</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Developer documentation for emuStudio" aria-label="Search Developer documentation for emuStudio" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="/" class="site-button" > Back to website </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <script type="text/javascript"> gtag('event', 'developerdoc', { 'event_category': 'developer_compiler', 'event_label': 'Writing a compiler' }); </script> <h1 id="writing-a-compiler"> <a href="#writing-a-compiler" class="anchor-heading" aria-labelledby="writing-a-compiler"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Writing a compiler </h1> <p>A compiler plugin must either implement <a href="/documentation/developer/emulib_javadoc/net/emustudio/emulib/plugins/compiler/Compiler.html" target="_blank">Compiler</a> interface, or extend more bloat-free <a href="/documentation/developer/emulib_javadoc/net/emustudio/emulib/plugins/compiler/AbstractCompiler.html" target="_blank">AbstractCompiler</a> class. Common practice is to utilize <a href="https://www.antlr.org/" target="_blank">ANTLR</a> parser generator, which has a direct runtime support in emuStudio.</p> <p>As every plug-in root class, compiler class must use annotation <a href="/documentation/developer/emulib_javadoc/net/emustudio/emulib/plugins/annotations/PluginRoot.html" target="_blank">PluginRoot</a>.</p> <p>Sample implementation of a compiler might look as follows (just some methods are implemented):</p> <div class="language-java code-example highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@PluginRoot</span><span class="o">(</span>
        <span class="n">type</span> <span class="o">=</span> <span class="no">PLUGIN_TYPE</span><span class="o">.</span><span class="na">COMPILER</span><span class="o">,</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">"Sample compiler"</span>
<span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompilerImpl</span> <span class="kd">extends</span> <span class="nc">AbstractCompiler</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">Logger</span> <span class="no">LOGGER</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">CompilerImpl</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">SourceFileExtension</span><span class="o">&gt;</span> <span class="no">SOURCE_FILE_EXTENSIONS</span> <span class="o">=</span> <span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
            <span class="k">new</span> <span class="nf">SourceFileExtension</span><span class="o">(</span><span class="s">"asm"</span><span class="o">,</span> <span class="s">"Assembler source file"</span><span class="o">)</span>
    <span class="o">);</span>

    <span class="kd">private</span> <span class="nc">MemoryContext</span><span class="o">&lt;</span><span class="nc">Byte</span><span class="o">&gt;</span> <span class="n">memory</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">programLocation</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">CompilerImpl</span><span class="o">(</span><span class="kt">long</span> <span class="n">pluginID</span><span class="o">,</span> <span class="nc">ApplicationApi</span> <span class="n">applicationApi</span><span class="o">,</span> <span class="nc">PluginSettings</span> <span class="n">settings</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">pluginID</span><span class="o">,</span> <span class="n">applicationApi</span><span class="o">,</span> <span class="n">settings</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"unchecked"</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">PluginInitializationException</span> <span class="o">{</span>
        <span class="nc">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">applicationApi</span><span class="o">.</span><span class="na">getContextPool</span><span class="o">()).</span><span class="na">ifPresent</span><span class="o">(</span><span class="n">pool</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">memory</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="na">getMemoryContext</span><span class="o">(</span><span class="n">pluginID</span><span class="o">,</span> <span class="nc">MemoryContext</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">memory</span><span class="o">.</span><span class="na">getDataType</span><span class="o">()</span> <span class="o">!=</span> <span class="nc">Byte</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">InvalidContextException</span><span class="o">(</span>
                            <span class="s">"Unexpected memory cell type. Expected Byte but was: "</span> <span class="o">+</span> <span class="n">memory</span><span class="o">.</span><span class="na">getDataType</span><span class="o">()</span>
                    <span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InvalidContextException</span> <span class="o">|</span> <span class="nc">ContextNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="no">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Memory is not available"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">compile</span><span class="o">(</span><span class="nc">String</span> <span class="n">inputFileName</span><span class="o">,</span> <span class="nc">String</span> <span class="n">outputFileName</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">notifyCompileStart</span><span class="o">();</span>
        <span class="n">notifyInfo</span><span class="o">(</span><span class="n">getTitle</span><span class="o">()</span> <span class="o">+</span> <span class="s">", version "</span> <span class="o">+</span> <span class="n">getVersion</span><span class="o">());</span>

        <span class="k">try</span> <span class="o">(</span><span class="nc">Reader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileReader</span><span class="o">(</span><span class="n">inputFileName</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">SampleLexer</span> <span class="n">lexer</span> <span class="o">=</span> <span class="n">createLexer</span><span class="o">(</span><span class="nc">CharStreams</span><span class="o">.</span><span class="na">fromReader</span><span class="o">(</span><span class="n">reader</span><span class="o">));</span>
            <span class="n">lexer</span><span class="o">.</span><span class="na">addErrorListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ParserErrorListener</span><span class="o">());</span>
            <span class="nc">CommonTokenStream</span> <span class="n">tokens</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CommonTokenStream</span><span class="o">(</span><span class="n">lexer</span><span class="o">);</span>

            <span class="nc">SampleParser</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">createParser</span><span class="o">(</span><span class="n">tokens</span><span class="o">);</span>
            <span class="n">parser</span><span class="o">.</span><span class="na">addErrorListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ParserErrorListener</span><span class="o">());</span>

            <span class="nc">Program</span> <span class="n">program</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Program</span><span class="o">();</span> <span class="c1">// TODO: Create your AST</span>
            <span class="n">program</span><span class="o">.</span><span class="na">setFileName</span><span class="o">(</span><span class="n">inputFileName</span><span class="o">);</span>
            <span class="k">new</span> <span class="nf">CreateProgramVisitor</span><span class="o">(</span><span class="n">program</span><span class="o">).</span><span class="na">visit</span><span class="o">(</span><span class="n">parser</span><span class="o">.</span><span class="na">rStart</span><span class="o">());</span> <span class="c1">// TODO: Create AST creator visitor</span>

            <span class="nc">IntelHEX</span> <span class="n">hex</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IntelHEX</span><span class="o">();</span>
            <span class="nc">NodeVisitor</span><span class="o">[]</span> <span class="n">visitors</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">NodeVisitor</span><span class="o">[]{</span>
                    <span class="c1">// TODO: create your semantic analysis and code generating visitors</span>
            <span class="o">};</span>

            <span class="k">for</span> <span class="o">(</span><span class="nc">NodeVisitor</span> <span class="n">visitor</span> <span class="o">:</span> <span class="n">visitors</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">visitor</span><span class="o">.</span><span class="na">visit</span><span class="o">(</span><span class="n">program</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">programLocation</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">program</span><span class="o">.</span><span class="na">env</span><span class="o">().</span><span class="na">hasNoErrors</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">hex</span><span class="o">.</span><span class="na">generate</span><span class="o">(</span><span class="n">outputFileName</span><span class="o">);</span>
                <span class="n">programLocation</span> <span class="o">=</span> <span class="n">hex</span><span class="o">.</span><span class="na">findProgramLocation</span><span class="o">();</span>

                <span class="n">notifyInfo</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
                        <span class="s">"Compile was successful.\n\tOutput: %s\n\tProgram starts at 0x%s"</span><span class="o">,</span>
                        <span class="n">outputFileName</span><span class="o">,</span> <span class="nc">RadixUtils</span><span class="o">.</span><span class="na">formatWordHexString</span><span class="o">(</span><span class="n">programLocation</span><span class="o">)</span>
                <span class="o">));</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">memory</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">hex</span><span class="o">.</span><span class="na">loadIntoMemory</span><span class="o">(</span><span class="n">memory</span><span class="o">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span><span class="o">);</span>
                    <span class="n">notifyInfo</span><span class="o">(</span><span class="s">"Compiled file was loaded into memory."</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">notifyWarning</span><span class="o">(</span><span class="s">"Memory is not available."</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">CompileError</span> <span class="n">error</span> <span class="o">:</span> <span class="n">program</span><span class="o">.</span><span class="na">env</span><span class="o">().</span><span class="na">getErrors</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">notifyError</span><span class="o">(</span><span class="n">error</span><span class="o">.</span><span class="na">line</span><span class="o">,</span> <span class="n">error</span><span class="o">.</span><span class="na">column</span><span class="o">,</span> <span class="n">error</span><span class="o">.</span><span class="na">msg</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">CompileException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">notifyError</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">line</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">column</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">notifyError</span><span class="o">(</span><span class="s">"Compilation error: "</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">notifyCompileFinish</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">compile</span><span class="o">(</span><span class="nc">String</span> <span class="n">inputFileName</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">outputFileName</span> <span class="o">=</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">inputFileName</span><span class="o">);</span>
        <span class="nc">SourceFileExtension</span> <span class="n">srcExtension</span> <span class="o">=</span> <span class="no">SOURCE_FILE_EXTENSIONS</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">inputFileName</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">(</span><span class="nc">Locale</span><span class="o">.</span><span class="na">ENGLISH</span><span class="o">).</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="s">"."</span> <span class="o">+</span> <span class="n">srcExtension</span><span class="o">.</span><span class="na">getExtension</span><span class="o">());</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">outputFileName</span> <span class="o">=</span> <span class="n">outputFileName</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nf">compile</span><span class="o">(</span><span class="n">inputFileName</span><span class="o">,</span> <span class="n">outputFileName</span> <span class="o">+</span> <span class="s">".hex"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">LexicalAnalyzer</span> <span class="nf">createLexer</span><span class="o">(</span><span class="nc">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SampleLexer</span> <span class="n">lexer</span> <span class="o">=</span> <span class="n">createLexer</span><span class="o">(</span><span class="nc">CharStreams</span><span class="o">.</span><span class="na">fromString</span><span class="o">(</span><span class="n">s</span><span class="o">));</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">LexicalAnalyzerImpl</span><span class="o">(</span><span class="n">lexer</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getProgramLocation</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">programLocation</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">SourceFileExtension</span><span class="o">&gt;</span> <span class="nf">getSourceFileExtensions</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="no">SOURCE_FILE_EXTENSIONS</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getVersion</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"1.0.0"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getCopyright</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"(c) Copyright 2006-2023, you"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getDescription</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"Sample compiler"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">SampleLexer</span> <span class="nf">createLexer</span><span class="o">(</span><span class="nc">CharStream</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// TODO: create your lexer</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">SampleParser</span> <span class="nf">createParser</span><span class="o">(</span><span class="nc">TokenStream</span> <span class="n">tokenStream</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// TODO: create your parser</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> <p>Main outcomes are:</p> <ul> <li>this sample compiler uses ANTLR parser generator for generating parser and lexer - they must be written manually</li> <li>it optionally loads program output into memory</li> <li>it generates output file in Intel HEX format</li> <li>AST (abstract syntax tree) in form of classes must be written manually</li> <li>All semantic-analysis visitors must be written manually, including code generation (this is probably the hardest compiler work)</li> </ul> <p>The compiler does not register any plugin context, but when initialized, it obtains optional memory context (in this example, memory must have cells of <code class="language-plaintext highlighter-rouge">Byte</code> type). If the memory is available, after compilation the program will be loaded in the memory.</p> <p>Lexer and parser are not shown here, but they are created using mentioned <a href="https://www.antlr.org/" target="_blank">ANTLR</a> parser generator. Please check out this nice <a href="https://tomassetti.me/antlr-mega-tutorial/" target="_blank">ANTLR tutorial</a>.</p> <p>The compiler utilizes a helper class <a href="/documentation/developer/emulib_javadoc/net/emustudio/emulib/runtime/helpers/IntelHEX.html" target="_blank">IntelHEX</a> from emuLib for generating output files.</p> <p>Abstract syntax tree is the most important part of the compiler. In general, the flow of transforming the source code into output is going through AST. In the beginning, AST is isomorphic to the parse tree. Then some transformations are applied - like expression evaluation, include files expansion, by-value identifiers replacements, intermediate code generation with relative addresses, macro expansion, preprocessor code evaluation, absolute address assignment and final transformation into binary code or whatever the compiler produces. So in time, AST changes, nodes are moved, replaced by others, or removed. At the final stage, AST represents program output.</p> <p>Transformations of AST is best done using visitors (see <a href="https://refactoring.guru/design-patterns/visitor" target="_blank">Visitor pattern</a>). A visitor is accepting some or all node types from the AST and performs changes to the nodes, or the whole AST. Itâ€™s a detached, isolated functionality operating on AST, which can be separately tested.</p> <p>For more information, see the code of some existing compilers.</p> <h2 id="lexical-analyzer"> <a href="#lexical-analyzer" class="anchor-heading" aria-labelledby="lexical-analyzer"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Lexical analyzer </h2> <p>emuStudio application uses standardized token types in order to support syntax highlighting in general, for any compiler kind. It is thus required to provide a lexer which returns emuStudio-like token types:</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">LexicalAnalyzer</span> <span class="kd">extends</span> <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Token</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nc">Token</span> <span class="nf">nextToken</span><span class="o">();</span>

    <span class="kt">boolean</span> <span class="nf">isAtEOF</span><span class="o">();</span>

    <span class="kt">void</span> <span class="nf">reset</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">is</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div> <p>The implementation is usually manual, tokens generated by ANTLR are converted into the standardized variants, e.g.:</p> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LexicalAnalyzerImpl</span> <span class="kd">implements</span> <span class="nc">LexicalAnalyzer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">tokenMap</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="nc">SampleLexer</span><span class="o">.</span><span class="na">EOL</span> <span class="o">+</span> <span class="mi">1</span><span class="o">];</span> <span class="c1">// highest number</span>

    <span class="kd">static</span> <span class="o">{</span> <span class="c1">// TODO: not complete</span>
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">COMMENT</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">COMMENT</span><span class="o">;</span>
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">EOL</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">WHITESPACE</span><span class="o">;</span>
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">WS</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">WHITESPACE</span><span class="o">;</span>
        
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">OPCODE_ADC</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">RESERVED</span><span class="o">;</span>
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">OPCODE_AND</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">RESERVED</span><span class="o">;</span>
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">OPCODE_ADD</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">RESERVED</span><span class="o">;</span>
        
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">PREP_ORG</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">PREPROCESSOR</span><span class="o">;</span>
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">PREP_EQU</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">PREPROCESSOR</span><span class="o">;</span>
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">PREP_VAR</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">PREPROCESSOR</span><span class="o">;</span>
        
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">REG_A</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">REGISTER</span><span class="o">;</span>
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">REG_B</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">REGISTER</span><span class="o">;</span>
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">REG_C</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">REGISTER</span><span class="o">;</span>
        
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">SEP_LPAR</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">SEPARATOR</span><span class="o">;</span>
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">SEP_RPAR</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">SEPARATOR</span><span class="o">;</span>
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">SEP_COMMA</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">SEPARATOR</span><span class="o">;</span>
        
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">OP_ADD</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">OPERATOR</span><span class="o">;</span>
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">OP_SUBTRACT</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">OPERATOR</span><span class="o">;</span>
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">OP_MULTIPLY</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">OPERATOR</span><span class="o">;</span>
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">OP_DIVIDE</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">OPERATOR</span><span class="o">;</span>
        
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">LIT_NUMBER</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">LITERAL</span><span class="o">;</span>
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">LIT_HEXNUMBER</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">LITERAL</span><span class="o">;</span>
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">LIT_OCTNUMBER</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">LITERAL</span><span class="o">;</span>
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">LIT_STRING</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">LITERAL</span><span class="o">;</span>

        <span class="n">tokenMap</span><span class="o">[</span><span class="no">ID_IDENTIFIER</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">IDENTIFIER</span><span class="o">;</span>
        <span class="n">tokenMap</span><span class="o">[</span><span class="no">ID_LABEL</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">IDENTIFIER</span><span class="o">;</span>

        <span class="n">tokenMap</span><span class="o">[</span><span class="no">ERROR</span><span class="o">]</span> <span class="o">=</span> <span class="nc">Token</span><span class="o">.</span><span class="na">ERROR</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">SampleLexer</span> <span class="n">lexer</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">LexicalAnalyzerImpl</span><span class="o">(</span><span class="nc">SampleLexer</span> <span class="n">lexer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lexer</span> <span class="o">=</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">requireNonNull</span><span class="o">(</span><span class="n">lexer</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Token</span> <span class="nf">nextToken</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">org</span><span class="o">.</span><span class="na">antlr</span><span class="o">.</span><span class="na">v4</span><span class="o">.</span><span class="na">runtime</span><span class="o">.</span><span class="na">Token</span> <span class="n">token</span> <span class="o">=</span> <span class="n">lexer</span><span class="o">.</span><span class="na">nextToken</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Token</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getType</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="nf">convertLexerTokenType</span><span class="o">(</span><span class="n">token</span><span class="o">.</span><span class="na">getType</span><span class="o">());</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getOffset</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">token</span><span class="o">.</span><span class="na">getStartIndex</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getText</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">token</span><span class="o">.</span><span class="na">getText</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">};</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAtEOF</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">lexer</span><span class="o">.</span><span class="na">_hitEOF</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">reset</span><span class="o">(</span><span class="nc">InputStream</span> <span class="n">inputStream</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">lexer</span><span class="o">.</span><span class="na">setInputStream</span><span class="o">(</span><span class="nc">CharStreams</span><span class="o">.</span><span class="na">fromStream</span><span class="o">(</span><span class="n">inputStream</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">convertLexerTokenType</span><span class="o">(</span><span class="kt">int</span> <span class="n">tokenType</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">tokenType</span> <span class="o">==</span> <span class="no">EOF</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Token</span><span class="o">.</span><span class="na">EOF</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">tokenMap</span><span class="o">[</span><span class="n">tokenType</span><span class="o">];</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
